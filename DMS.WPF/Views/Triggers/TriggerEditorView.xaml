<UserControl x:Class="DMS.WPF.Views.Triggers.TriggerEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:DMS.WPF.Views.Triggers"
             xmlns:viewmodels="clr-namespace:DMS.WPF.ViewModels.Triggers;assembly=DMS.WPF"
             xmlns:converters="clr-namespace:DMS.WPF.Converters;assembly=DMS.WPF"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="600"
             MinWidth="500" MinHeight="500">
    <UserControl.DataContext>
        <viewmodels:TriggerEditorViewModel />
    </UserControl.DataContext>
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Grid.Row="0" Text="{Binding Title}" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>

        <!-- ScrollViewer for form content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- Basic Info Section -->
                <GroupBox Header="基本信息" Padding="5">
                    <StackPanel>
                        <DockPanel Margin="0,0,0,5">
                            <Label Content="关联变量:" Width="100" VerticalAlignment="Center"/>
                            <ComboBox ItemsSource="{Binding AvailableVariables}" 
                                      DisplayMemberPath="Name"
                                      SelectedValuePath="Id"
                                      SelectedValue="{Binding Trigger.VariableId}"
                                      Width="200" HorizontalAlignment="Left"/>
                        </DockPanel>
                        
                        <DockPanel Margin="0,0,0,5">
                            <Label Content="描述:" Width="100" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding Trigger.Description, UpdateSourceTrigger=PropertyChanged}" 
                                     Width="300" HorizontalAlignment="Left"/>
                        </DockPanel>
                        
                        <CheckBox Content="激活" IsChecked="{Binding Trigger.IsActive}" Margin="0,0,0,5"/>
                    </StackPanel>
                </GroupBox>

                <!-- Condition Section -->
                <GroupBox Header="触发条件" Padding="5" Margin="0,10,0,0">
                    <StackPanel>
                        <DockPanel Margin="0,0,0,5">
                            <Label Content="条件类型:" Width="100" VerticalAlignment="Center"/>
                            <ComboBox ItemsSource="{Binding Source={StaticResource ConditionTypeEnum}}"
                                      SelectedItem="{Binding Trigger.Condition}"
                                      Width="200" HorizontalAlignment="Left"/>
                        </DockPanel>

                        <!-- Conditional Fields based on Condition Type -->
                        <StackPanel Visibility="{Binding Trigger.Condition, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=GreaterThan}">
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="阈值:" Width="100" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Trigger.Threshold, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                        </StackPanel>
                        
                        <StackPanel Visibility="{Binding Trigger.Condition, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=LessThan}">
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="阈值:" Width="100" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Trigger.Threshold, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                        </StackPanel>
                        
                        <StackPanel Visibility="{Binding Trigger.Condition, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=EqualTo}">
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="阈值:" Width="100" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Trigger.Threshold, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                        </StackPanel>
                        
                        <StackPanel Visibility="{Binding Trigger.Condition, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=NotEqualTo}">
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="阈值:" Width="100" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Trigger.Threshold, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                        </StackPanel>
                        
                        <StackPanel Visibility="{Binding Trigger.Condition, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=InRange}">
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="下限:" Width="100" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Trigger.LowerBound, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="上限:" Width="100" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Trigger.UpperBound, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                        </StackPanel>
                        
                        <StackPanel Visibility="{Binding Trigger.Condition, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=OutOfRange}">
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="下限:" Width="100" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Trigger.LowerBound, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="上限:" Width="100" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Trigger.UpperBound, UpdateSourceTrigger=PropertyChanged}" 
                                         Width="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                        </StackPanel>
                    </StackPanel>
                </GroupBox>

                <!-- Action Section -->
                <GroupBox Header="触发动作" Padding="5" Margin="0,10,0,0">
                    <StackPanel>
                        <DockPanel Margin="0,0,0,5">
                            <Label Content="动作类型:" Width="100" VerticalAlignment="Center"/>
                            <ComboBox ItemsSource="{Binding Source={StaticResource ActionTypeEnum}}"
                                      SelectedItem="{Binding Trigger.Action}"
                                      Width="200" HorizontalAlignment="Left"/>
                        </DockPanel>

                        <!-- Conditional Fields based on Action Type -->
                        <StackPanel Visibility="{Binding Trigger.Action, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=SendEmail}">
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="收件人 (分号分隔):" Width="150" VerticalAlignment="Top"/>
                                <TextBox Text="{Binding EmailRecipients, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" 
                                         AcceptsReturn="True" TextWrapping="Wrap"
                                         Width="350" Height="60" HorizontalAlignment="Left"/>
                            </DockPanel>
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="邮件主题模板:" Width="150" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding EmailSubjectTemplate, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" 
                                         Width="350" HorizontalAlignment="Left"/>
                            </DockPanel>
                            <DockPanel Margin="0,0,0,5">
                                <Label Content="邮件内容模板:" Width="150" VerticalAlignment="Top"/>
                                <TextBox Text="{Binding EmailBodyTemplate, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" 
                                         AcceptsReturn="True" TextWrapping="Wrap"
                                         Width="350" Height="100" HorizontalAlignment="Left"/>
                            </DockPanel>
                        </StackPanel>
                        
                        <!-- Add placeholders for other action types if needed -->
                        <StackPanel Visibility="{Binding Trigger.Action, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=ActivateAlarm}">
                            <TextBlock Text="配置激活报警动作..." Margin="5"/>
                        </StackPanel>
                        
                        <StackPanel Visibility="{Binding Trigger.Action, Converter={StaticResource LocalEnumToVisibilityConverter}, ConverterParameter=WriteToLog}">
                            <TextBlock Text="配置写入日志动作..." Margin="5"/>
                        </StackPanel>
                    </StackPanel>
                </GroupBox>

                <!-- Suppression Section -->
                <GroupBox Header="抑制设置" Padding="5" Margin="0,10,0,0">
                    <StackPanel>
                        <DockPanel Margin="0,0,0,5">
                            <Label Content="抑制持续时间 (秒):" Width="150" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding Trigger.SuppressionDuration, Converter={StaticResource NullableTimeSpanToSecondsConverter}, UpdateSourceTrigger=PropertyChanged}" 
                                     Width="100" HorizontalAlignment="Left"/>
                        </DockPanel>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </ScrollViewer>

        <!-- Buttons -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button Content="{Binding PrimaryButText}" Command="{Binding SaveCommand}" Margin="0,0,5,0" Width="80"/>
            <Button Content="取消" Command="{Binding CancelCommand}" Width="80"/>
        </StackPanel>
    </Grid>
</UserControl>